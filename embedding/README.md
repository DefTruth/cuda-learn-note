# embedding

## 0x00 说明

包含以下内容：

- [X] embedding_f32_kernel
- [X] embedding_f32x4_kernel(float4向量化版本)
- [X] embedding_f32x4_pack_kernel(float4向量化，pack版本版本)
- [X] embedding_f16_kernel(fp16版本)
- [X] embedding_f16x8_kernel(fp16向量化版本)
- [X] embedding_f16x8_pack_kernel(fp16向量化，pack版本)
- [X] PyTorch bindings


## 测试

```bash
# 只测试Ada架构 不指定默认编译所有架构 耗时较长: Volta, Ampere, Ada, Hopper, ...
export TORCH_CUDA_ARCH_LIST=Ada 
python3 embedding.py
```
一个elemwise的操作，但是有个值得探究的问题，在f16下pack的性能优于没有pack的性能但是在f32下相反
输出:

```bash
--------------------------------------------------------------------------------------------------------------
                                             MaxV=1024, SeqLen=2048, EmbSize=512
                out_f32: ['0.86887586  ', '-0.01706419 ', '0.73080146  '], time:0.008023ms
              out_f32x4: ['0.86887586  ', '-0.01706419 ', '0.73080146  '], time:0.004721ms
         out_f32x4_pack: ['0.86887586  ', '-0.01706419 ', '0.73080146  '], time:0.005066ms
             out_f32_th: ['0.86887586  ', '-0.01706419 ', '0.73080146  '], time:0.013971ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['-0.2154541  ', '1.04492188  ', '0.27270508  '], time:0.006449ms
              out_f16x8: ['-0.2154541  ', '1.04492188  ', '0.27270508  '], time:0.004530ms
         out_f16x8_pack: ['-0.2154541  ', '1.04492188  ', '0.27270508  '], time:0.003755ms
             out_f16_th: ['-0.2154541  ', '1.04492188  ', '0.27270508  '], time:0.013721ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=1024, SeqLen=2048, EmbSize=1024
                out_f32: ['0.66981     ', '0.4241927   ', '-0.15340355 '], time:0.024498ms
              out_f32x4: ['0.66981     ', '0.4241927   ', '-0.15340355 '], time:0.006783ms
         out_f32x4_pack: ['0.66981     ', '0.4241927   ', '-0.15340355 '], time:0.018096ms
             out_f32_th: ['0.66981     ', '0.4241927   ', '-0.15340355 '], time:0.035846ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['1.09472656  ', '-1.06054688 ', '0.26489258  '], time:0.016439ms
              out_f16x8: ['1.09472656  ', '-1.06054688 ', '0.26489258  '], time:0.006139ms
         out_f16x8_pack: ['1.09472656  ', '-1.06054688 ', '0.26489258  '], time:0.005293ms
             out_f16_th: ['1.09472656  ', '-1.06054688 ', '0.26489258  '], time:0.025201ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=1024, SeqLen=4096, EmbSize=512
                out_f32: ['1.28044033  ', '2.35704017  ', '-0.30134526 '], time:0.016963ms
              out_f32x4: ['1.28044033  ', '2.35704017  ', '-0.30134526 '], time:0.006747ms
         out_f32x4_pack: ['1.28044033  ', '2.35704017  ', '-0.30134526 '], time:0.014734ms
             out_f32_th: ['1.28044033  ', '2.35704017  ', '-0.30134526 '], time:0.025642ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['-0.16345215 ', '-1.0        ', '-0.39550781 '], time:0.010574ms
              out_f16x8: ['-0.16345215 ', '-1.0        ', '-0.39550781 '], time:0.006568ms
         out_f16x8_pack: ['-0.16345215 ', '-1.0        ', '-0.39550781 '], time:0.005209ms
             out_f16_th: ['-0.16345215 ', '-1.0        ', '-0.39550781 '], time:0.025201ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=1024, SeqLen=4096, EmbSize=1024
                out_f32: ['-0.40867445 ', '-0.8335858  ', '-0.49254218 '], time:0.046313ms
              out_f32x4: ['-0.40867445 ', '-0.8335858  ', '-0.49254218 '], time:0.011313ms
         out_f32x4_pack: ['-0.40867445 ', '-0.8335858  ', '-0.49254218 '], time:0.032842ms
             out_f32_th: ['-0.40867445 ', '-0.8335858  ', '-0.49254218 '], time:0.052702ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['-0.83496094 ', '1.04394531  ', '1.39257812  '], time:0.037646ms
              out_f16x8: ['-0.83496094 ', '1.04394531  ', '1.39257812  '], time:0.009596ms
         out_f16x8_pack: ['-0.83496094 ', '1.04394531  ', '1.39257812  '], time:0.014734ms
             out_f16_th: ['-0.83496094 ', '1.04394531  ', '1.39257812  '], time:0.047410ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=4096, SeqLen=2048, EmbSize=512
                out_f32: ['0.15961131  ', '-0.19337949 ', '1.44166911  '], time:0.012183ms
              out_f32x4: ['0.15961131  ', '-0.19337949 ', '1.44166911  '], time:0.004745ms
         out_f32x4_pack: ['0.15961131  ', '-0.19337949 ', '1.44166911  '], time:0.008714ms
             out_f32_th: ['0.15961131  ', '-0.19337949 ', '1.44166911  '], time:0.015748ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['-0.59716797 ', '-0.17419434 ', '0.68212891  '], time:0.006747ms
              out_f16x8: ['-0.59716797 ', '-0.17419434 ', '0.68212891  '], time:0.004554ms
         out_f16x8_pack: ['-0.59716797 ', '-0.17419434 ', '0.68212891  '], time:0.003779ms
             out_f16_th: ['-0.59716797 ', '-0.17419434 ', '0.68212891  '], time:0.013590ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=4096, SeqLen=2048, EmbSize=1024
                out_f32: ['-0.01857017 ', '-0.22317575 ', '0.30234769  '], time:0.027883ms
              out_f32x4: ['-0.01857017 ', '-0.22317575 ', '0.30234769  '], time:0.006914ms
         out_f32x4_pack: ['-0.01857017 ', '-0.22317575 ', '0.30234769  '], time:0.021565ms
             out_f32_th: ['-0.01857017 ', '-0.22317575 ', '0.30234769  '], time:0.028121ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['-0.64306641 ', '0.63085938  ', '-1.125      '], time:0.022829ms
              out_f16x8: ['-0.64306641 ', '0.63085938  ', '-1.125      '], time:0.006104ms
         out_f16x8_pack: ['-0.64306641 ', '0.63085938  ', '-1.125      '], time:0.008368ms
             out_f16_th: ['-0.64306641 ', '0.63085938  ', '-1.125      '], time:0.026560ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=4096, SeqLen=4096, EmbSize=512
                out_f32: ['0.29845014  ', '-1.42925274 ', '-1.13554442 '], time:0.021946ms
              out_f32x4: ['0.29845014  ', '-1.42925274 ', '-1.13554442 '], time:0.006795ms
         out_f32x4_pack: ['0.29845014  ', '-1.42925274 ', '-1.13554442 '], time:0.020158ms
             out_f32_th: ['0.29845014  ', '-1.42925274 ', '-1.13554442 '], time:0.027788ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['-1.61132812 ', '-0.59326172 ', '-1.29492188 '], time:0.015080ms
              out_f16x8: ['-1.61132812 ', '-0.59326172 ', '-1.29492188 '], time:0.006652ms
         out_f16x8_pack: ['-1.61132812 ', '-0.59326172 ', '-1.29492188 '], time:0.007749ms
             out_f16_th: ['-1.61132812 ', '-0.59326172 ', '-1.29492188 '], time:0.025988ms
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
                                             MaxV=4096, SeqLen=4096, EmbSize=1024
                out_f32: ['2.47914457  ', '-0.17796712 ', '-0.30882221 '], time:0.052547ms
              out_f32x4: ['2.47914457  ', '-0.17796712 ', '-0.30882221 '], time:0.013256ms
         out_f32x4_pack: ['2.47914457  ', '-0.17796712 ', '-0.30882221 '], time:0.040042ms
             out_f32_th: ['2.47914457  ', '-0.17796712 ', '-0.30882221 '], time:0.058615ms
--------------------------------------------------------------------------------------------------------------
                out_f16: ['0.25146484  ', '-1.85449219 ', '1.96289062  '], time:0.043607ms
              out_f16x8: ['0.25146484  ', '-1.85449219 ', '1.96289062  '], time:0.009620ms
         out_f16x8_pack: ['0.25146484  ', '-1.85449219 ', '1.96289062  '], time:0.020134ms
             out_f16_th: ['0.25146484  ', '-1.85449219 ', '1.96289062  '], time:0.048840ms
--------------------------------------------------------------------------------------------------------------
```
