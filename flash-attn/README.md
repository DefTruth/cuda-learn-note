# FlashAttention

## 0x00 说明

包含以下内容：

- [X] flash_attn_1_fwd_f32_kernel 
- [ ] flash_attn_2_fwd_f32_kernel
- [ ] flash_attn_2_fwd_f16_kernel
- [x] flash_attn_2_fwd_f16_mma_m16n8k16_kernel
- [X] PyTorch bindings

### 运行测试   
```bash
# 只测试Ada架构 不指定默认编译所有架构 耗时较长: Volta, Ampere, Ada, Hopper, ...
export TORCH_CUDA_ARCH_LIST=Ada 
python3 flash_attn.py
```
日志如下：
```bash
----------------------------------------------------------------------------------------------------
                         B: batch_size, H: n_head, N: seq_len, D: head_dim
----------------------------------------------------------------------------------------------------
                                        B=4, H=8, N=256, D=64
              out_FA1f32: ['0.05004965  ', '0.04726661  ', '-0.04774433 '], time:9.300125ms
      out_FA1f32(nocopy): ['0.05004965  ', '0.04726661  ', '-0.04774433 '], time:9.287107ms
              out_f32_th: ['0.05004967  ', '0.04726657  ', '-0.04774434 '], time:0.057316ms
----------------------------------------------------------------------------------------------------
           out_FA2MMAf16: ['0.05007935  ', '0.04727173  ', '-0.04769897 '], time:0.054514ms
   out_FA2MMAf16(nocopy): ['0.05007935  ', '0.04727173  ', '-0.04769897 '], time:0.045109ms
              out_f16_th: ['0.05004883  ', '0.04730225  ', '-0.04782104 '], time:0.056386ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                        B=4, H=8, N=256, D=128
----------------------------------------------------------------------------------------------------
           out_FA2MMAf16: ['-0.08343506 ', '0.14416504  ', '0.1081543   '], time:0.088656ms
   out_FA2MMAf16(nocopy): ['-0.08343506 ', '0.14416504  ', '0.1081543   '], time:0.085831ms
              out_f16_th: ['-0.08349609 ', '0.14416504  ', '0.10821533  '], time:0.055230ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                        B=4, H=8, N=512, D=64
              out_FA1f32: ['0.17229594  ', '0.07826595  ', '-0.10381219 '], time:37.064552ms
      out_FA1f32(nocopy): ['0.17229594  ', '0.07826595  ', '-0.10381219 '], time:37.068295ms
              out_f32_th: ['0.17229596  ', '0.07826599  ', '-0.1038122  '], time:0.167549ms
----------------------------------------------------------------------------------------------------
           out_FA2MMAf16: ['0.17211914  ', '0.07836914  ', '-0.10394287 '], time:0.166595ms
   out_FA2MMAf16(nocopy): ['0.17211914  ', '0.07836914  ', '-0.10394287 '], time:0.163591ms
              out_f16_th: ['0.17236328  ', '0.07824707  ', '-0.10388184 '], time:0.064313ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                        B=4, H=8, N=512, D=128
----------------------------------------------------------------------------------------------------
           out_FA2MMAf16: ['-0.01485443 ', '-0.01541901 ', '0.01047516  '], time:0.321484ms
   out_FA2MMAf16(nocopy): ['-0.01485443 ', '-0.01541901 ', '0.01047516  '], time:0.317943ms
              out_f16_th: ['-0.01487732 ', '-0.01539612 ', '0.01045227  '], time:0.085497ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                        B=4, H=8, N=1024, D=64
              out_FA1f32: ['0.06363252  ', '0.00870894  ', '-0.00227917 '], time:148.094833ms
      out_FA1f32(nocopy): ['0.06363252  ', '0.00870894  ', '-0.00227917 '], time:148.087347ms
              out_f32_th: ['0.06363251  ', '0.00870894  ', '-0.00227916 '], time:1.405525ms
----------------------------------------------------------------------------------------------------
           out_FA2MMAf16: ['0.0635376   ', '0.00880432  ', '-0.00226784 '], time:0.635731ms
   out_FA2MMAf16(nocopy): ['0.0635376   ', '0.00880432  ', '-0.00226784 '], time:0.631654ms
              out_f16_th: ['0.06359863  ', '0.00874329  ', '-0.0022583  '], time:0.441146ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                        B=4, H=8, N=1024, D=128
----------------------------------------------------------------------------------------------------
           out_FA2MMAf16: ['0.06689453  ', '-0.05187988 ', '0.00821686  '], time:1.233840ms
   out_FA2MMAf16(nocopy): ['0.06689453  ', '-0.05187988 ', '0.00821686  '], time:1.227772ms
              out_f16_th: ['0.06695557  ', '-0.05184937 ', '0.00813293  '], time:0.545263ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                        B=8, H=8, N=256, D=64
              out_FA1f32: ['-0.05929435 ', '-0.09249968 ', '-0.01854437 '], time:9.290612ms
      out_FA1f32(nocopy): ['-0.05929435 ', '-0.09249968 ', '-0.01854437 '], time:9.287369ms
              out_f32_th: ['-0.05929432 ', '-0.09249966 ', '-0.01854436 '], time:0.088072ms
----------------------------------------------------------------------------------------------------
           out_FA2MMAf16: ['-0.05932617 ', '-0.09234619 ', '-0.0184021  '], time:0.050902ms
   out_FA2MMAf16(nocopy): ['-0.05932617 ', '-0.09234619 ', '-0.0184021  '], time:0.047922ms
              out_f16_th: ['-0.05926514 ', '-0.09246826 ', '-0.01850891 '], time:0.055134ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                        B=8, H=8, N=256, D=128
----------------------------------------------------------------------------------------------------
           out_FA2MMAf16: ['-0.08398438 ', '0.01913452  ', '0.0144043   '], time:0.095391ms
   out_FA2MMAf16(nocopy): ['-0.08398438 ', '0.01913452  ', '0.0144043   '], time:0.091386ms
              out_f16_th: ['-0.08392334 ', '0.01913452  ', '0.01431274  '], time:0.055325ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                        B=8, H=8, N=512, D=64
              out_FA1f32: ['-0.0281368  ', '-0.08599149 ', '-0.07104071 '], time:37.064385ms
      out_FA1f32(nocopy): ['-0.0281368  ', '-0.08599149 ', '-0.07104071 '], time:37.061369ms
              out_f32_th: ['-0.02813675 ', '-0.08599151 ', '-0.07104069 '], time:0.472212ms
----------------------------------------------------------------------------------------------------
           out_FA2MMAf16: ['-0.02810669 ', '-0.08599854 ', '-0.07110596 '], time:0.171292ms
   out_FA2MMAf16(nocopy): ['-0.02810669 ', '-0.08599854 ', '-0.07110596 '], time:0.167680ms
              out_f16_th: ['-0.02815247 ', '-0.08599854 ', '-0.07110596 '], time:0.134265ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                        B=8, H=8, N=512, D=128
----------------------------------------------------------------------------------------------------
           out_FA2MMAf16: ['-0.00336838 ', '0.0002321   ', '-0.01806641 '], time:0.333524ms
   out_FA2MMAf16(nocopy): ['-0.00336838 ', '0.0002321   ', '-0.01806641 '], time:0.327265ms
              out_f16_th: ['-0.00340271 ', '0.00017107  ', '-0.01809692 '], time:0.158370ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                        B=8, H=8, N=1024, D=64
              out_FA1f32: ['-0.03192434 ', '-0.02465032 ', '-0.03229533 '], time:148.094475ms
      out_FA1f32(nocopy): ['-0.03192434 ', '-0.02465032 ', '-0.03229533 '], time:148.086023ms
              out_f32_th: ['-0.03192437 ', '-0.02465032 ', '-0.03229532 '], time:2.675152ms
----------------------------------------------------------------------------------------------------
           out_FA2MMAf16: ['-0.03186035 ', '-0.02461243 ', '-0.0322876  '], time:0.642049ms
   out_FA2MMAf16(nocopy): ['-0.03186035 ', '-0.02461243 ', '-0.0322876  '], time:0.637412ms
              out_f16_th: ['-0.03192139 ', '-0.02464294 ', '-0.03222656 '], time:1.281929ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                        B=8, H=8, N=1024, D=128
----------------------------------------------------------------------------------------------------
           out_FA2MMAf16: ['0.0165863   ', '0.08190918  ', '-0.04156494 '], time:1.245689ms
   out_FA2MMAf16(nocopy): ['0.0165863   ', '0.08190918  ', '-0.04156494 '], time:1.236022ms
              out_f16_th: ['0.01651001  ', '0.08197021  ', '-0.04147339 '], time:1.373148ms
----------------------------------------------------------------------------------------------------
```
