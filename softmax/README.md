# Softmax

## 0x00 说明

包含以下内容：

- [X] softmax_f32_kernel (grid level memory fence)
- [X] softmax_f32x4_kernel(grid level memory fence)
- [X] softmax_f32_per_token_kernel(per token)
- [X] softmax_f32x4_per_token_kernel(per token)
- [X] safe_softmax_f32_per_token_kernel(per token)
- [X] safe_softmax_f32x4_per_token_kernel(per token)
- [X] safe_softmax_f16_f32_per_token_kernel(per token)
- [X] safe_softmax_f16x2_f32_per_token_kernel(per token)
- [X] safe_softmax_f16x8_pack_f32_per_token_kernel(per token)
- [X] online_softmax_f32_per_token_kernel(per token)
- [X] PyTorch bindings


## 测试

```bash
# 只测试Ada架构 不指定默认编译所有架构 耗时较长: Volta, Ampere, Ada, Hopper, ...
export TORCH_CUDA_ARCH_LIST=Ada 
python3 softmax.py
```

输出:

```bash
----------------------------------------------------------------------------------------------------
                                             N=16384
----------------------------------------------------------------------------------------------------
          out_f32(fence): ['0.0001818   ', '2.871e-05   ', '1.654e-05   '], time:0.01005864ms
        out_f32x4(fence): ['0.0001818   ', '2.871e-05   ', '1.654e-05   '], time:0.01013398ms
              out_f32_th: ['0.0001818   ', '2.871e-05   ', '1.654e-05   '], time:0.00574422ms
----------------------------------------------------------------------------------------------------
                                             S=4096, H=256
----------------------------------------------------------------------------------------------------
            out_f32(per): ['0.00147849  ', '0.00544109  ', '0.00260214  '], time:0.00628543ms
          out_f32x4(per): ['0.00147849  ', '0.00544109  ', '0.00260214  '], time:0.00391006ms
           out_f32(safe): ['0.00147849  ', '0.00544109  ', '0.00260214  '], time:0.00938845ms
         out_f32(online): ['0.00147849  ', '0.00544109  ', '0.00260214  '], time:0.00748181ms
         out_f32x4(safe): ['0.00147849  ', '0.00544109  ', '0.00260214  '], time:0.00409913ms
         out_f32_th(per): ['0.00147849  ', '0.00544109  ', '0.00260214  '], time:0.00574255ms
----------------------------------------------------------------------------------------------------
        out_f16f32(safe): ['0.0014782   ', '0.00543976  ', '0.00260162  '], time:0.00908256ms
      out_f16x2f32(safe): ['0.0014782   ', '0.00543976  ', '0.00260162  '], time:0.00524139ms
  out_f16x8packf32(safe): ['0.0014782   ', '0.00543976  ', '0.00260162  '], time:0.00410175ms
         out_f16_th(per): ['0.0014782   ', '0.00543976  ', '0.00260162  '], time:0.00578189ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=512
----------------------------------------------------------------------------------------------------
            out_f32(per): ['0.00239257  ', '0.00083338  ', '0.00081047  '], time:0.01133442ms
          out_f32x4(per): ['0.00239257  ', '0.00083338  ', '0.00081047  '], time:0.00510907ms
           out_f32(safe): ['0.00239257  ', '0.00083338  ', '0.00081047  '], time:0.01829219ms
         out_f32(online): ['0.00239257  ', '0.00083338  ', '0.00081047  '], time:0.01355910ms
         out_f32x4(safe): ['0.00239257  ', '0.00083338  ', '0.00081047  '], time:0.00574207ms
         out_f32_th(per): ['0.00239257  ', '0.00083338  ', '0.00081047  '], time:0.00646853ms
----------------------------------------------------------------------------------------------------
        out_f16f32(safe): ['0.00239182  ', '0.00083351  ', '0.00081062  '], time:0.01768661ms
      out_f16x2f32(safe): ['0.00239182  ', '0.00083351  ', '0.00081062  '], time:0.00910544ms
  out_f16x8packf32(safe): ['0.00239182  ', '0.00083351  ', '0.00081062  '], time:0.00410581ms
         out_f16_th(per): ['0.00239182  ', '0.00083351  ', '0.00081062  '], time:0.00588131ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=1024
----------------------------------------------------------------------------------------------------
            out_f32(per): ['0.00115465  ', '0.00075291  ', '0.00049737  '], time:0.03181624ms
          out_f32x4(per): ['0.00115465  ', '0.00075291  ', '0.00049737  '], time:0.00854707ms
           out_f32(safe): ['0.00115465  ', '0.00075291  ', '0.00049737  '], time:0.04854369ms
         out_f32(online): ['0.00115465  ', '0.00075291  ', '0.00049737  '], time:0.03684497ms
         out_f32x4(safe): ['0.00115465  ', '0.00075291  ', '0.00049737  '], time:0.01018882ms
         out_f32_th(per): ['0.00115465  ', '0.00075291  ', '0.00049737  '], time:0.01166248ms
----------------------------------------------------------------------------------------------------
        out_f16f32(safe): ['0.0011549   ', '0.00075293  ', '0.00049734  '], time:0.04658127ms
      out_f16x2f32(safe): ['0.0011549   ', '0.00075293  ', '0.00049734  '], time:0.01799035ms
  out_f16x8packf32(safe): ['0.0011549   ', '0.00075293  ', '0.00049734  '], time:0.00601220ms
         out_f16_th(per): ['0.0011549   ', '0.00075293  ', '0.00049734  '], time:0.01032948ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=2048
----------------------------------------------------------------------------------------------------
          out_f32x4(per): ['0.00120965  ', '0.0003052   ', '0.00031494  '], time:0.01588249ms
         out_f32x4(safe): ['0.00120965  ', '0.0003052   ', '0.00031494  '], time:0.02069235ms
         out_f32_th(per): ['0.00120965  ', '0.0003052   ', '0.00031494  '], time:0.06703091ms
----------------------------------------------------------------------------------------------------
      out_f16x2f32(safe): ['0.00120926  ', '0.00030518  ', '0.00031495  '], time:0.04809165ms
  out_f16x8packf32(safe): ['0.00120926  ', '0.00030518  ', '0.00031495  '], time:0.01072788ms
         out_f16_th(per): ['0.00120926  ', '0.00030518  ', '0.00031495  '], time:0.07217050ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=4096
----------------------------------------------------------------------------------------------------
          out_f32x4(per): ['7.593e-05   ', '0.00014689  ', '3.727e-05   '], time:0.18450260ms
         out_f32x4(safe): ['7.593e-05   ', '0.00014689  ', '3.727e-05   '], time:0.18568420ms
         out_f32_th(per): ['7.593e-05   ', '0.00014689  ', '3.727e-05   '], time:0.18726397ms
----------------------------------------------------------------------------------------------------
  out_f16x8packf32(safe): ['7.594e-05   ', '0.00014687  ', '3.725e-05   '], time:0.02228618ms
         out_f16_th(per): ['7.594e-05   ', '0.00014687  ', '3.725e-05   '], time:0.08253646ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=8192
----------------------------------------------------------------------------------------------------
  out_f16x8packf32(safe): ['5.06e-05    ', '1.848e-05   ', '0.00019264  '], time:0.19308233ms
         out_f16_th(per): ['5.06e-05    ', '1.848e-05   ', '0.00019264  '], time:0.19358587ms
----------------------------------------------------------------------------------------------------
                                             S=8192, H=8192
----------------------------------------------------------------------------------------------------
  out_f16x8packf32(safe): ['5.472e-05   ', '3.362e-05   ', '5.263e-05   '], time:0.39822674ms
         out_f16_th(per): ['5.472e-05   ', '3.362e-05   ', '5.263e-05   '], time:0.40595865ms
----------------------------------------------------------------------------------------------------
```
