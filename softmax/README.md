# Softmax

## 0x00 说明

包含以下内容：

- [X] softmax_f32_kernel (grid level memory fence)
- [X] softmax_f32x4_kernel(grid level memory fence)
- [X] softmax_f32_per_token_kernel(per token)
- [X] softmax_f32x4_per_token_kernel(per token)
- [X] safe_softmax_f32_per_token_kernel(per token)
- [X] safe_softmax_f32x4_per_token_kernel(per token)
- [X] safe_softmax_f16_f32_per_token_kernel(per token)
- [X] safe_softmax_f16x2_f32_per_token_kernel(per token)
- [X] safe_softmax_f16x8_pack_f32_per_token_kernel(per token)
- [X] online_safe_softmax_f32_per_token_kernel(per token, online softmax)
- [X] PyTorch bindings


## 测试

```bash
# 只测试Ada架构 不指定默认编译所有架构 耗时较长: Volta, Ampere, Ada, Hopper, ...
export TORCH_CUDA_ARCH_LIST=Ada 
python3 softmax.py
```

输出:

```bash
----------------------------------------------------------------------------------------------------
                                             N=16384
----------------------------------------------------------------------------------------------------
          out_f32(fence): ['3.359e-05   ', '1.657e-05   ', '0.0001522   '], time:0.01000977ms
        out_f32x4(fence): ['3.359e-05   ', '1.657e-05   ', '0.0001522   '], time:0.01015735ms
              out_f32_th: ['3.359e-05   ', '1.657e-05   ', '0.0001522   '], time:0.00575948ms
----------------------------------------------------------------------------------------------------
                                             S=4096, H=256
----------------------------------------------------------------------------------------------------
            out_f32(per): ['0.00425925  ', '0.00819569  ', '0.00073704  '], time:0.00633717ms
          out_f32x4(per): ['0.00425925  ', '0.00819569  ', '0.00073704  '], time:0.00395060ms
           out_f32(safe): ['0.00425925  ', '0.00819569  ', '0.00073704  '], time:0.00937152ms
    out_f32(safe+online): ['0.00425925  ', '0.00819569  ', '0.00073704  '], time:0.00749898ms
         out_f32x4(safe): ['0.00425925  ', '0.00819569  ', '0.00073704  '], time:0.00413203ms
         out_f32_th(per): ['0.00425925  ', '0.00819569  ', '0.00073704  '], time:0.00574470ms
----------------------------------------------------------------------------------------------------
        out_f16f32(safe): ['0.00426102  ', '0.00819397  ', '0.00073671  '], time:0.00907254ms
      out_f16x2f32(safe): ['0.00426102  ', '0.00819397  ', '0.00073671  '], time:0.00526237ms
  out_f16x8packf32(safe): ['0.00426102  ', '0.00819397  ', '0.00073671  '], time:0.00414038ms
         out_f16_th(per): ['0.00426102  ', '0.00819397  ', '0.00073671  '], time:0.00579095ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=512
----------------------------------------------------------------------------------------------------
            out_f32(per): ['0.00203266  ', '7.054e-05   ', '0.00042398  '], time:0.01142383ms
          out_f32x4(per): ['0.00203266  ', '7.054e-05   ', '0.00042398  '], time:0.00514126ms
           out_f32(safe): ['0.00203266  ', '7.054e-05   ', '0.00042398  '], time:0.01835704ms
    out_f32(safe+online): ['0.00203266  ', '7.054e-05   ', '0.00042398  '], time:0.01364374ms
         out_f32x4(safe): ['0.00203266  ', '7.054e-05   ', '0.00042398  '], time:0.00578308ms
         out_f32_th(per): ['0.00203266  ', '7.054e-05   ', '0.00042398  '], time:0.00650859ms
----------------------------------------------------------------------------------------------------
        out_f16f32(safe): ['0.00203323  ', '7.057e-05   ', '0.00042415  '], time:0.01780558ms
      out_f16x2f32(safe): ['0.00203323  ', '7.057e-05   ', '0.00042415  '], time:0.00920749ms
  out_f16x8packf32(safe): ['0.00203323  ', '7.057e-05   ', '0.00042415  '], time:0.00416279ms
         out_f16_th(per): ['0.00203323  ', '7.057e-05   ', '0.00042415  '], time:0.00592852ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=1024
----------------------------------------------------------------------------------------------------
            out_f32(per): ['4.202e-05   ', '0.00064992  ', '0.00070006  '], time:0.03191423ms
          out_f32x4(per): ['4.202e-05   ', '0.00064992  ', '0.00070006  '], time:0.00858426ms
           out_f32(safe): ['4.202e-05   ', '0.00064992  ', '0.00070006  '], time:0.04868317ms
    out_f32(safe+online): ['4.202e-05   ', '0.00064992  ', '0.00070006  '], time:0.03698754ms
         out_f32x4(safe): ['4.202e-05   ', '0.00064992  ', '0.00070006  '], time:0.01025891ms
         out_f32_th(per): ['4.202e-05   ', '0.00064992  ', '0.00070006  '], time:0.01172018ms
----------------------------------------------------------------------------------------------------
        out_f16f32(safe): ['4.202e-05   ', '0.00064993  ', '0.0007      '], time:0.04668665ms
      out_f16x2f32(safe): ['4.202e-05   ', '0.00064993  ', '0.0007      '], time:0.01805592ms
  out_f16x8packf32(safe): ['4.202e-05   ', '0.00064993  ', '0.0007      '], time:0.00600147ms
         out_f16_th(per): ['4.202e-05   ', '0.00064993  ', '0.0007      '], time:0.01042104ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=2048
----------------------------------------------------------------------------------------------------
          out_f32x4(per): ['0.00068028  ', '0.00138677  ', '0.00012553  '], time:0.01602578ms
         out_f32x4(safe): ['0.00068028  ', '0.00138677  ', '0.00012553  '], time:0.02085137ms
         out_f32_th(per): ['0.00068028  ', '0.00138677  ', '0.00012553  '], time:0.06727862ms
----------------------------------------------------------------------------------------------------
      out_f16x2f32(safe): ['0.00067997  ', '0.00138664  ', '0.00012553  '], time:0.04822373ms
  out_f16x8packf32(safe): ['0.00067997  ', '0.00138664  ', '0.00012553  '], time:0.01078343ms
         out_f16_th(per): ['0.00067997  ', '0.00138664  ', '0.00012553  '], time:0.07226229ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=4096
----------------------------------------------------------------------------------------------------
          out_f32x4(per): ['3.5e-05     ', '8.788e-05   ', '0.00017372  '], time:0.18450212ms
         out_f32x4(safe): ['3.5e-05     ', '8.788e-05   ', '0.00017372  '], time:0.18548727ms
         out_f32_th(per): ['3.5e-05     ', '8.788e-05   ', '0.00017372  '], time:0.18735909ms
----------------------------------------------------------------------------------------------------
  out_f16x8packf32(safe): ['3.499e-05   ', '8.792e-05   ', '0.00017369  '], time:0.02230954ms
         out_f16_th(per): ['3.499e-05   ', '8.792e-05   ', '0.00017369  '], time:0.08258724ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=8192
----------------------------------------------------------------------------------------------------
  out_f16x8packf32(safe): ['8.47e-05    ', '0.00048876  ', '2.718e-05   '], time:0.19314885ms
         out_f16_th(per): ['8.47e-05    ', '0.00048876  ', '2.718e-05   '], time:0.19355965ms
----------------------------------------------------------------------------------------------------
                                             S=8192, H=8192
----------------------------------------------------------------------------------------------------
  out_f16x8packf32(safe): ['5.829e-05   ', '8.482e-05   ', '0.00021875  '], time:0.39851356ms
         out_f16_th(per): ['5.829e-05   ', '8.482e-05   ', '0.00021875  '], time:0.40570927ms
----------------------------------------------------------------------------------------------------
```
