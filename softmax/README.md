# Softmax

## 0x00 说明

包含以下内容：

- [X] softmax_f32_kernel (grid level memory fence)
- [X] softmax_f32x4_kernel(grid level memory fence)
- [X] softmax_f32_per_token_kernel(per token)
- [X] softmax_f32x4_per_token_kernel(per token)
- [X] safe_softmax_f32_per_token_kernel(per token)
- [X] safe_softmax_f32x4_per_token_kernel(per token)
- [X] safe_softmax_f16_f32_per_token_kernel(per token)
- [X] safe_softmax_f16x2_f32_per_token_kernel(per token)
- [X] safe_softmax_f16x8_pack_f32_per_token_kernel(per token)
- [X] online_safe_softmax_f32_per_token_kernel(per token, online softmax)
- [X] online_safe_softmax_f32x4_pack_per_token_kernel(per token, online softmax)
- [X] PyTorch bindings


## 测试

```bash
# 只测试Ada架构 不指定默认编译所有架构 耗时较长: Volta, Ampere, Ada, Hopper, ...
export TORCH_CUDA_ARCH_LIST=Ada 
python3 softmax.py
```

输出:

```bash
----------------------------------------------------------------------------------------------------
                                             N=16384
----------------------------------------------------------------------------------------------------
          out_f32(fence): ['4.141e-05   ', '1.092e-05   ', '0.00024727  '], time:0.00670123ms
        out_f32x4(fence): ['4.141e-05   ', '1.092e-05   ', '0.00024727  '], time:0.00658965ms
              out_f32_th: ['4.141e-05   ', '1.092e-05   ', '0.00024727  '], time:0.00869846ms
----------------------------------------------------------------------------------------------------
                                             S=4096, H=256
----------------------------------------------------------------------------------------------------
            out_f32(per): ['0.00046426  ', '0.00100964  ', '0.02180685  '], time:0.01262426ms
          out_f32x4(per): ['0.00046426  ', '0.00100964  ', '0.02180685  '], time:0.01005673ms
           out_f32(safe): ['0.00046426  ', '0.00100964  ', '0.02180685  '], time:0.01589751ms
    out_f32(safe+online): ['0.00046426  ', '0.00100964  ', '0.02180685  '], time:0.01357889ms
         out_f32x4(safe): ['0.00046426  ', '0.00100964  ', '0.02180685  '], time:0.01028609ms
         out_f32_th(per): ['0.00046426  ', '0.00100964  ', '0.02180685  '], time:0.01042962ms
----------------------------------------------------------------------------------------------------
        out_f16f32(safe): ['0.0004642   ', '0.00100994  ', '0.02180481  '], time:0.01418209ms
      out_f16x2f32(safe): ['0.0004642   ', '0.00100994  ', '0.02180481  '], time:0.00781465ms
  out_f16x8packf32(safe): ['0.0004642   ', '0.00100994  ', '0.02180481  '], time:0.00516081ms
         out_f16_th(per): ['0.0004642   ', '0.00100994  ', '0.02180481  '], time:0.00565004ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=512
----------------------------------------------------------------------------------------------------
            out_f32(per): ['0.00119272  ', '0.00053399  ', '0.00139735  '], time:0.02369642ms
          out_f32x4(per): ['0.00119272  ', '0.00053399  ', '0.00139735  '], time:0.02221465ms
           out_f32(safe): ['0.00119272  ', '0.00053399  ', '0.00139735  '], time:0.03093553ms
    out_f32(safe+online): ['0.00119272  ', '0.00053399  ', '0.00139735  '], time:0.02545881ms
  out_f32x4(safe+online): ['0.00119272  ', '0.00053399  ', '0.00139735  '], time:0.02225614ms
         out_f32x4(safe): ['0.00119272  ', '0.00053399  ', '0.00139735  '], time:0.02230763ms
         out_f32_th(per): ['0.00119272  ', '0.00053399  ', '0.00139735  '], time:0.02293873ms
----------------------------------------------------------------------------------------------------
        out_f16f32(safe): ['0.00119305  ', '0.00053406  ', '0.00139713  '], time:0.02964735ms
      out_f16x2f32(safe): ['0.00119305  ', '0.00053406  ', '0.00139713  '], time:0.01562166ms
  out_f16x8packf32(safe): ['0.00119305  ', '0.00053406  ', '0.00139713  '], time:0.01035237ms
         out_f16_th(per): ['0.00119305  ', '0.00053406  ', '0.00139713  '], time:0.01411271ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=1024
----------------------------------------------------------------------------------------------------
            out_f32(per): ['0.00071695  ', '0.00080019  ', '0.00072992  '], time:0.06140566ms
          out_f32x4(per): ['0.00071695  ', '0.00080019  ', '0.00072992  '], time:0.04210520ms
           out_f32(safe): ['0.00071695  ', '0.00080019  ', '0.00072992  '], time:0.08843923ms
    out_f32(safe+online): ['0.00071695  ', '0.00080019  ', '0.00072992  '], time:0.06825924ms
  out_f32x4(safe+online): ['0.00071695  ', '0.00080019  ', '0.00072992  '], time:0.04216075ms
         out_f32x4(safe): ['0.00071695  ', '0.00080019  ', '0.00072992  '], time:0.04224324ms
         out_f32_th(per): ['0.00071695  ', '0.00080019  ', '0.00072992  '], time:0.04250860ms
----------------------------------------------------------------------------------------------------
        out_f16f32(safe): ['0.00071716  ', '0.00080013  ', '0.00073004  '], time:0.08206987ms
      out_f16x2f32(safe): ['0.00071716  ', '0.00080013  ', '0.00073004  '], time:0.02941418ms
  out_f16x8packf32(safe): ['0.00071716  ', '0.00080013  ', '0.00073004  '], time:0.02221346ms
         out_f16_th(per): ['0.00071716  ', '0.00080013  ', '0.00073004  '], time:0.02485061ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=2048
----------------------------------------------------------------------------------------------------
          out_f32x4(per): ['0.00038824  ', '0.00111044  ', '6.228e-05   '], time:0.08172154ms
         out_f32x4(safe): ['0.00038824  ', '0.00111044  ', '6.228e-05   '], time:0.08195257ms
         out_f32_th(per): ['0.00038824  ', '0.00111044  ', '6.228e-05   '], time:0.10085511ms
----------------------------------------------------------------------------------------------------
      out_f16x2f32(safe): ['0.00038815  ', '0.00111008  ', '6.229e-05   '], time:0.07896614ms
  out_f16x8packf32(safe): ['0.00038815  ', '0.00111008  ', '6.229e-05   '], time:0.04206061ms
         out_f16_th(per): ['0.00038815  ', '0.00111008  ', '6.229e-05   '], time:0.05345869ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=4096
----------------------------------------------------------------------------------------------------
          out_f32x4(per): ['6.954e-05   ', '0.00010892  ', '0.00014108  '], time:0.16202521ms
         out_f32x4(safe): ['6.954e-05   ', '0.00010892  ', '0.00014108  '], time:0.16278386ms
         out_f32_th(per): ['6.954e-05   ', '0.00010892  ', '0.00014108  '], time:0.19021225ms
----------------------------------------------------------------------------------------------------
  out_f16x8packf32(safe): ['6.956e-05   ', '0.0001089   ', '0.00014102  '], time:0.08190370ms
         out_f16_th(per): ['6.956e-05   ', '0.0001089   ', '0.00014102  '], time:0.10035086ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=8192
----------------------------------------------------------------------------------------------------
  out_f16x8packf32(safe): ['0.00017381  ', '7.379e-05   ', '1.323e-05   '], time:0.16339087ms
         out_f16_th(per): ['0.00017381  ', '7.379e-05   ', '1.323e-05   '], time:0.18723893ms
----------------------------------------------------------------------------------------------------
                                             S=8192, H=8192
----------------------------------------------------------------------------------------------------
  out_f16x8packf32(safe): ['0.00015759  ', '0.00013983  ', '0.00011808  '], time:0.32360601ms
         out_f16_th(per): ['0.00015759  ', '0.00013983  ', '0.00011808  '], time:0.36617398ms
----------------------------------------------------------------------------------------------------
```
