# Softmax

## 0x00 说明

包含以下内容：

- [X] softmax_f32_kernel (grid level memory fence)
- [X] softmax_f32x4_kernel(grid level memory fence)
- [X] softmax_f32_per_token_kernel(per token)
- [X] softmax_f32x4_per_token_kernel(per token)
- [X] safe_softmax_f32_per_token_kernel(per token)
- [X] safe_softmax_f32x4_per_token_kernel(per token)
- [X] safe_softmax_f16_f32_per_token_kernel(per token)
- [X] safe_softmax_f16x2_f32_per_token_kernel(per token)
- [X] safe_softmax_f16x8_pack_f32_per_token_kernel(per token)
- [X] PyTorch bindings


## 测试

```bash
# 只测试Ada架构 不指定默认编译所有架构 耗时较长: Volta, Ampere, Ada, Hopper, ...
export TORCH_CUDA_ARCH_LIST=Ada 
python3 softmax.py
```

输出:

```bash
----------------------------------------------------------------------------------------------------
                                             N=16384
----------------------------------------------------------------------------------------------------
          out_f32(fence): ['5.912e-05   ', '9.61e-05    ', '4.271e-05   '], time:0.01040053ms
        out_f32x4(fence): ['5.912e-05   ', '9.61e-05    ', '4.271e-05   '], time:0.01053643ms
              out_f32_th: ['5.912e-05   ', '9.61e-05    ', '4.271e-05   '], time:0.00582504ms
----------------------------------------------------------------------------------------------------
                                             S=4096, H=256
----------------------------------------------------------------------------------------------------
            out_f32(per): ['0.0015298   ', '0.00619088  ', '0.00529766  '], time:0.00627208ms
          out_f32x4(per): ['0.0015298   ', '0.00619088  ', '0.00529766  '], time:0.00394082ms
           out_f32(safe): ['0.0015298   ', '0.00619088  ', '0.00529766  '], time:0.00941491ms
         out_f32x4(safe): ['0.0015298   ', '0.00619088  ', '0.00529766  '], time:0.00413442ms
         out_f32_th(per): ['0.0015298   ', '0.00619088  ', '0.00529766  '], time:0.00602674ms
----------------------------------------------------------------------------------------------------
        out_f16f32(safe): ['0.00152969  ', '0.00619125  ', '0.00529861  '], time:0.00912046ms
      out_f16x2f32(safe): ['0.00152969  ', '0.00619125  ', '0.00529861  '], time:0.00522232ms
  out_f16x8packf32(safe): ['0.00152969  ', '0.00619125  ', '0.00529861  '], time:0.00413895ms
         out_f16_th(per): ['0.00152969  ', '0.00619125  ', '0.00529861  '], time:0.00605321ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=512
----------------------------------------------------------------------------------------------------
            out_f32(per): ['0.00200376  ', '0.00063461  ', '0.00163568  '], time:0.01139641ms
          out_f32x4(per): ['0.00200376  ', '0.00063461  ', '0.00163568  '], time:0.00515914ms
           out_f32(safe): ['0.00200376  ', '0.00063461  ', '0.00163568  '], time:0.01834297ms
         out_f32x4(safe): ['0.00200376  ', '0.00063461  ', '0.00163568  '], time:0.00574923ms
         out_f32_th(per): ['0.00200376  ', '0.00063461  ', '0.00163568  '], time:0.00657558ms
----------------------------------------------------------------------------------------------------
        out_f16f32(safe): ['0.00200462  ', '0.00063467  ', '0.00163555  '], time:0.01782560ms
      out_f16x2f32(safe): ['0.00200462  ', '0.00063467  ', '0.00163555  '], time:0.00919509ms
  out_f16x8packf32(safe): ['0.00200462  ', '0.00063467  ', '0.00163555  '], time:0.00415683ms
         out_f16_th(per): ['0.00200462  ', '0.00063467  ', '0.00163555  '], time:0.00634599ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=1024
----------------------------------------------------------------------------------------------------
            out_f32(per): ['0.0009461   ', '0.00073918  ', '0.00074397  '], time:0.03191805ms
          out_f32x4(per): ['0.0009461   ', '0.00073918  ', '0.00074397  '], time:0.00862813ms
           out_f32(safe): ['0.0009461   ', '0.00073918  ', '0.00074397  '], time:0.04873967ms
         out_f32x4(safe): ['0.0009461   ', '0.00073918  ', '0.00074397  '], time:0.01027441ms
         out_f32_th(per): ['0.0009461   ', '0.00073918  ', '0.00074397  '], time:0.01181388ms
----------------------------------------------------------------------------------------------------
        out_f16f32(safe): ['0.00094604  ', '0.0007391   ', '0.00074387  '], time:0.04671884ms
      out_f16x2f32(safe): ['0.00094604  ', '0.0007391   ', '0.00074387  '], time:0.01810408ms
  out_f16x8packf32(safe): ['0.00094604  ', '0.0007391   ', '0.00074387  '], time:0.00601912ms
         out_f16_th(per): ['0.00094604  ', '0.0007391   ', '0.00074387  '], time:0.01047063ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=2048
----------------------------------------------------------------------------------------------------
          out_f32x4(per): ['9.216e-05   ', '0.00045569  ', '0.00013162  '], time:0.01605988ms
         out_f32x4(safe): ['9.216e-05   ', '0.00045569  ', '0.00013162  '], time:0.02089310ms
         out_f32_th(per): ['9.216e-05   ', '0.00045569  ', '0.00013162  '], time:0.06726241ms
----------------------------------------------------------------------------------------------------
      out_f16x2f32(safe): ['9.215e-05   ', '0.00045562  ', '0.00013161  '], time:0.04824972ms
  out_f16x8packf32(safe): ['9.215e-05   ', '0.00045562  ', '0.00013161  '], time:0.01086283ms
         out_f16_th(per): ['9.215e-05   ', '0.00045562  ', '0.00013161  '], time:0.07232165ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=4096
----------------------------------------------------------------------------------------------------
          out_f32x4(per): ['0.00017665  ', '0.00035685  ', '0.00017236  '], time:0.18465948ms
         out_f32x4(safe): ['0.00017665  ', '0.00035685  ', '0.00017236  '], time:0.18565655ms
         out_f32_th(per): ['0.00017665  ', '0.00035685  ', '0.00017236  '], time:0.18744922ms
----------------------------------------------------------------------------------------------------
  out_f16x8packf32(safe): ['0.00017667  ', '0.00035691  ', '0.00017238  '], time:0.02254891ms
         out_f16_th(per): ['0.00017667  ', '0.00035691  ', '0.00017238  '], time:0.08283138ms
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
                                             S=4096, H=8192
----------------------------------------------------------------------------------------------------
  out_f16x8packf32(safe): ['4.166e-05   ', '3.767e-05   ', '1.562e-05   '], time:0.19313049ms
         out_f16_th(per): ['4.166e-05   ', '3.767e-05   ', '1.562e-05   '], time:0.19356799ms
----------------------------------------------------------------------------------------------------
                                             S=8192, H=8192
----------------------------------------------------------------------------------------------------
  out_f16x8packf32(safe): ['4.208e-05   ', '0.00015438  ', '7.409e-05   '], time:0.39828229ms
         out_f16_th(per): ['4.208e-05   ', '0.00015438  ', '7.409e-05   '], time:0.40599036ms
----------------------------------------------------------------------------------------------------
```
