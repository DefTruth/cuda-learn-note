# Reduce

## 0x00 说明

包含以下内容：

- [X] warp_reduce_fp32/fp16/bf16_kernel
- [X] block_reduce_fp32_kernel
- [X] block_all_reduce_sum_f32_f32_kernel
- [X] block_all_reduce_sum_f32x4_f32_kernel(float4向量化版本)
- [X] block_all_reduce_sum_f16_f16_kernel(fp16版本，使用fp16 acc)
- [X] block_all_reduce_sum_f16_f32_kernel(fp16版本，使用fp32 acc)
- [X] block_all_reduce_sum_f16x2_f16_kernel(fp16向量化版本，使用fp16 acc)
- [X] block_all_reduce_sum_f16x2_f32_kernel(fp16向量化版本，使用fp32 acc)
- [X] block_all_reduce_sum_f16x8_pack_f16_kernel(fp16向量化版本，使用fp16 acc, pack)
- [X] block_all_reduce_sum_f16x8_pack_f32_kernel(fp16向量化版本，使用fp32 acc, pack)
- [X] block_all_reduce_sum_bf16_bf16_kernel(bf16版本，使用bf16 acc)
- [X] block_all_reduce_sum_bf16_f32_kernel(bf16版本，使用fp32 acc)
- [X] block_all_reduce_sum_bf16x8_pack_bf16_kernel(bf16版本，使用bf16 acc, pack)
- [X] block_all_reduce_sum_bf16x8_pack_f32_kernel(bf16版本，使用fp32 acc, pack)
- [X] block_all_reduce_sum_bf16x2_bf16_kernel(bf16向量化版本，使用bf16 acc)
- [X] block_all_reduce_sum_bf16x2_f32_kernel(bf16向量化版本，使用fp32 acc)
- [X] block_all_reduce_sum_fp8_e4m3_f16_kernel(fp8_e4m3版本，使用fp16 acc)
- [X] block_all_reduce_sum_fp8_e5m2_f16_kernel(fp8_e5m2版本，使用fp16 acc)
- [X] block_all_reduce_sum_fp8_e4m3x16_pack_f16_kernel(fp8_e4m3版本，使用fp16 acc, pack)
- [X] block_all_reduce_sum_fp8_e5m2x16_pack_f16_kernel(fp8_e5m2版本，使用fp16 acc, pack)
- [X] block_all_reduce_sum_i8_i32_kernel(i8版本，使用i32 acc)
- [X] block_all_reduce_sum_i8x16_pack_i32_kernel(i8版本，使用i32 acc, pack)
- [X] PyTorch bindings for block reduce **fp32/fp16/bf16/fp8/i8** kernels

所有支持的block all reduce kernel:

```c++
// packed_type, acc_type, th_type, element_type, n_elements_per_pack, out_type
TORCH_BINDING_REDUCE(f32,              f32,  torch::kFloat32,       float,              1,  float)
TORCH_BINDING_REDUCE(f32x4,            f32,  torch::kFloat32,       float,              4,  float)
TORCH_BINDING_REDUCE(f16,              f16,  torch::kHalf,          half,               1,  float)
TORCH_BINDING_REDUCE(f16,              f32,  torch::kHalf,          half,               1,  float)
TORCH_BINDING_REDUCE(f16x2,            f16,  torch::kHalf,          half,               2,  float)
TORCH_BINDING_REDUCE(f16x2,            f32,  torch::kHalf,          half,               2,  float)
TORCH_BINDING_REDUCE(f16x8_pack,       f16,  torch::kHalf,          half,               8,  float)
TORCH_BINDING_REDUCE(f16x8_pack,       f32,  torch::kHalf,          half,               8,  float)
TORCH_BINDING_REDUCE(bf16,             bf16, torch::kBFloat16,      __nv_bfloat16,      1,  float)
TORCH_BINDING_REDUCE(bf16,             f32,  torch::kBFloat16,      __nv_bfloat16,      1,  float)
TORCH_BINDING_REDUCE(bf16x2,           bf16, torch::kBFloat16,      __nv_bfloat16,      2,  float)
TORCH_BINDING_REDUCE(bf16x2,           f32,  torch::kBFloat16,      __nv_bfloat16,      2,  float)
TORCH_BINDING_REDUCE(bf16x8_pack,      bf16, torch::kBFloat16,      __nv_bfloat16,      8,  float)
TORCH_BINDING_REDUCE(bf16x8_pack,      f32,  torch::kBFloat16,      __nv_bfloat16,      8,  float)
TORCH_BINDING_REDUCE(fp8_e4m3,         f16,  torch::kFloat8_e4m3fn, __nv_fp8_storage_t, 1,  float)
TORCH_BINDING_REDUCE(fp8_e4m3x16_pack, f16,  torch::kFloat8_e4m3fn, __nv_fp8_storage_t, 16, float)
TORCH_BINDING_REDUCE(fp8_e5m2,         f16,  torch::kFloat8_e5m2,   __nv_fp8_storage_t, 1,  float)
TORCH_BINDING_REDUCE(fp8_e5m2x16_pack, f16,  torch::kFloat8_e5m2,   __nv_fp8_storage_t, 16, float)
TORCH_BINDING_REDUCE(i8,               i32,  torch::kInt8,          int8_t,             1,  int32_t)
TORCH_BINDING_REDUCE(i8x16_pack,       i32,  torch::kInt8,          int8_t,             16, int32_t)
```

## 测试

```bash
# 只测试Ada架构 不指定默认编译所有架构 耗时较长: Volta, Ampere, Ada, Hopper, ...
export TORCH_CUDA_ARCH_LIST=Ada 
python3 block_all_reduce.py
```

输出:

```bash
--------------------------------------------------------------------------------
                                        S=1024, K=1024
               out_f32f32: -1137.62048340 , time:0.02713323ms
             out_f32x4f32: -1137.61999512 , time:0.01600742ms
            out_f32f32_th: -1137.62048340 , time:0.01785421ms
--------------------------------------------------------------------------------
               out_f16f16: -1137.52319336 , time:0.02696848ms
               out_f16f32: -1137.89685059 , time:0.02668238ms
             out_f16x2f32: -1138.13208008 , time:0.01842380ms
             out_f16x2f16: -1138.29492188 , time:0.07383990ms
         out_f16x8packf16: -1138.09765625 , time:0.01911044ms
         out_f16x8packf32: -1137.89660645 , time:0.01584816ms
            out_f16f16_th: -1138.00000000 , time:0.01785350ms
--------------------------------------------------------------------------------
             out_bf16bf16: -1130.21875000 , time:0.02584028ms
              out_bf16f32: -1135.23144531 , time:0.02633667ms
            out_bf16x2f32: -1137.14953613 , time:0.01821065ms
           out_bf16x2bf16: -1134.85937500 , time:0.01982117ms
        out_bf16x8packf32: -1134.40270996 , time:0.01468968ms
       out_bf16x8packbf16: -1134.03125000 , time:0.02862358ms
          out_bf16bf16_th: -1136.00000000 , time:0.07082796ms
--------------------------------------------------------------------------------
            out_f8e4m3f16: -1175.00390625 , time:0.02906251ms
     out_f8e4m3x16packf16: -1175.32421875 , time:0.03925204ms
         out_f8e4m3f16_th: -1175.00000000 , time:0.03107810ms
--------------------------------------------------------------------------------
            out_f8e5m2f16: -1098.24804688 , time:0.02956128ms
     out_f8e5m2x16packf16: -1097.67187500 , time:0.04100657ms
         out_f8e5m2f16_th: -1098.00000000 , time:0.04073381ms
--------------------------------------------------------------------------------
                out_i8i32: -62            , time:0.07767534ms
         out_i8x16packi32: -62            , time:0.02238870ms
             out_i8i32_th: -62            , time:0.05719018ms
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
                                        S=1024, K=2048
               out_f32f32: -570.26098633  , time:0.04499340ms
             out_f32x4f32: -570.26196289  , time:0.02867842ms
            out_f32f32_th: -570.26147461  , time:0.03160572ms
--------------------------------------------------------------------------------
               out_f16f16: -570.64587402  , time:0.03981447ms
               out_f16f32: -570.25524902  , time:0.05383539ms
             out_f16x2f32: -569.75231934  , time:0.02693391ms
             out_f16x2f16: -569.19702148  , time:0.02471352ms
         out_f16x8packf16: -569.61035156  , time:0.01750636ms
         out_f16x8packf32: -570.25494385  , time:0.01648736ms
            out_f16f16_th: -570.50000000  , time:0.01723075ms
--------------------------------------------------------------------------------
             out_bf16bf16: -578.60937500  , time:0.04147577ms
              out_bf16f32: -572.15417480  , time:0.06154156ms
            out_bf16x2f32: -573.22619629  , time:0.03536892ms
           out_bf16x2bf16: -578.73437500  , time:0.04764605ms
        out_bf16x8packf32: -568.90991211  , time:0.01702023ms
       out_bf16x8packbf16: -569.57812500  , time:0.01754880ms
          out_bf16bf16_th: -572.00000000  , time:0.01712537ms
--------------------------------------------------------------------------------
            out_f8e4m3f16: -555.76367188  , time:0.05983973ms
     out_f8e4m3x16packf16: -556.59375000  , time:0.01853204ms
         out_f8e4m3f16_th: -556.50000000  , time:0.09552908ms
--------------------------------------------------------------------------------
            out_f8e5m2f16: -644.88281250  , time:0.04396558ms
     out_f8e5m2x16packf16: -644.26562500  , time:0.02873921ms
         out_f8e5m2f16_th: -644.50000000  , time:0.05273509ms
--------------------------------------------------------------------------------
                out_i8i32: -210           , time:0.03860831ms
         out_i8x16packi32: -210           , time:0.01513004ms
             out_i8i32_th: -210           , time:0.10321760ms
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
                                        S=1024, K=4096
               out_f32f32: -3511.88891602 , time:0.08368158ms
             out_f32x4f32: -3511.89184570 , time:0.04683995ms
            out_f32f32_th: -3511.89086914 , time:0.05584693ms
--------------------------------------------------------------------------------
               out_f16f16: -3513.12597656 , time:0.08475614ms
               out_f16f32: -3511.77075195 , time:0.08343053ms
             out_f16x2f32: -3511.33911133 , time:0.03365088ms
             out_f16x2f16: -3512.42431641 , time:0.03456235ms
         out_f16x8packf16: -3511.08300781 , time:0.02765489ms
         out_f16x8packf32: -3511.77368164 , time:0.03055835ms
            out_f16f16_th: -3512.00000000 , time:0.05753827ms
--------------------------------------------------------------------------------
             out_bf16bf16: -3510.18750000 , time:0.08531117ms
              out_bf16f32: -3506.85034180 , time:0.08320212ms
            out_bf16x2f32: -3509.39697266 , time:0.03775167ms
           out_bf16x2bf16: -3524.50000000 , time:0.03640175ms
        out_bf16x8packf32: -3508.60278320 , time:0.02825403ms
       out_bf16x8packbf16: -3515.71875000 , time:0.03533602ms
          out_bf16bf16_th: -3504.00000000 , time:0.02914095ms
--------------------------------------------------------------------------------
            out_f8e4m3f16: -3493.94335938 , time:0.08401203ms
     out_f8e4m3x16packf16: -3491.82812500 , time:0.02486300ms
         out_f8e4m3f16_th: -3494.00000000 , time:0.03322864ms
--------------------------------------------------------------------------------
            out_f8e5m2f16: -3473.12109375 , time:0.07202387ms
     out_f8e5m2x16packf16: -3471.00781250 , time:0.01637387ms
         out_f8e5m2f16_th: -3474.00000000 , time:0.03054833ms
--------------------------------------------------------------------------------
                out_i8i32: -2332          , time:0.06964350ms
         out_i8x16packi32: -2332          , time:0.02869582ms
             out_i8i32_th: -2332          , time:0.19053745ms
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
                                        S=2048, K=1024
               out_f32f32: 222.81304932   , time:0.04629421ms
             out_f32x4f32: 222.81234741   , time:0.02711487ms
            out_f32f32_th: 222.81335449   , time:0.02928376ms
--------------------------------------------------------------------------------
               out_f16f16: 223.43017578   , time:0.03914571ms
               out_f16f32: 222.91725159   , time:0.05670476ms
             out_f16x2f32: 222.73464966   , time:0.03513050ms
             out_f16x2f16: 222.20703125   , time:0.05402613ms
         out_f16x8packf16: 222.60791016   , time:0.01846910ms
         out_f16x8packf32: 222.91639709   , time:0.05626798ms
            out_f16f16_th: 222.87500000   , time:0.01836944ms
--------------------------------------------------------------------------------
             out_bf16bf16: 234.35937500   , time:0.03817701ms
              out_bf16f32: 221.73806763   , time:0.03773236ms
            out_bf16x2f32: 225.55297852   , time:0.02003217ms
           out_bf16x2bf16: 225.90625000   , time:0.02294660ms
        out_bf16x8packf32: 225.33132935   , time:0.01773381ms
       out_bf16x8packbf16: 229.82812500   , time:0.02333736ms
          out_bf16bf16_th: 222.00000000   , time:0.02989340ms
--------------------------------------------------------------------------------
            out_f8e4m3f16: 201.74804688   , time:0.05056858ms
     out_f8e4m3x16packf16: 201.94726562   , time:0.01944113ms
         out_f8e4m3f16_th: 202.00000000   , time:0.02070069ms
--------------------------------------------------------------------------------
            out_f8e5m2f16: 230.83398438   , time:0.07535028ms
     out_f8e5m2x16packf16: 232.14062500   , time:0.01706338ms
         out_f8e5m2f16_th: 231.25000000   , time:0.03944135ms
--------------------------------------------------------------------------------
                out_i8i32: -254           , time:0.06159544ms
         out_i8x16packi32: -254           , time:0.01582789ms
             out_i8i32_th: -254           , time:0.10584974ms
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
                                        S=2048, K=2048
               out_f32f32: -1760.79846191 , time:0.08248663ms
             out_f32x4f32: -1760.80407715 , time:0.04664254ms
            out_f32f32_th: -1760.80187988 , time:0.04905581ms
--------------------------------------------------------------------------------
               out_f16f16: -1761.37939453 , time:0.08225346ms
               out_f16f32: -1761.30578613 , time:0.08218551ms
             out_f16x2f32: -1761.67663574 , time:0.04557371ms
             out_f16x2f16: -1762.75024414 , time:0.04447150ms
         out_f16x8packf16: -1763.14892578 , time:0.02932477ms
         out_f16x8packf32: -1761.30603027 , time:0.02764583ms
            out_f16f16_th: -1761.00000000 , time:0.03727126ms
--------------------------------------------------------------------------------
             out_bf16bf16: -1749.76562500 , time:0.08508658ms
              out_bf16f32: -1762.97546387 , time:0.08306742ms
            out_bf16x2f32: -1759.25781250 , time:0.07813740ms
           out_bf16x2bf16: -1758.95312500 , time:0.04652524ms
        out_bf16x8packf32: -1750.73315430 , time:0.05286407ms
       out_bf16x8packbf16: -1749.21875000 , time:0.02857351ms
          out_bf16bf16_th: -1760.00000000 , time:0.02897596ms
--------------------------------------------------------------------------------
            out_f8e4m3f16: -1684.82031250 , time:0.08574271ms
     out_f8e4m3x16packf16: -1683.18750000 , time:0.02756739ms
         out_f8e4m3f16_th: -1685.00000000 , time:0.02946115ms
--------------------------------------------------------------------------------
            out_f8e5m2f16: -1693.85351562 , time:0.07081318ms
     out_f8e5m2x16packf16: -1694.63671875 , time:0.01695347ms
         out_f8e5m2f16_th: -1695.00000000 , time:0.02915978ms
--------------------------------------------------------------------------------
                out_i8i32: -944           , time:0.07050490ms
         out_i8x16packi32: -944           , time:0.01676893ms
             out_i8i32_th: -944           , time:0.19250178ms
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
                                        S=2048, K=4096
               out_f32f32: -1819.31408691 , time:0.15871739ms
             out_f32x4f32: -1819.31640625 , time:0.08576417ms
            out_f32f32_th: -1819.31677246 , time:0.08819461ms
--------------------------------------------------------------------------------
               out_f16f16: -1819.30395508 , time:0.15881133ms
               out_f16f32: -1819.26416016 , time:0.15885353ms
             out_f16x2f32: -1818.81713867 , time:0.05966711ms
             out_f16x2f16: -1818.28259277 , time:0.06309724ms
         out_f16x8packf16: -1818.20312500 , time:0.07229066ms
         out_f16x8packf32: -1819.26391602 , time:0.04592633ms
            out_f16f16_th: -1819.00000000 , time:0.04833913ms
--------------------------------------------------------------------------------
             out_bf16bf16: -1806.80468750 , time:0.16615653ms
              out_bf16f32: -1825.83691406 , time:0.15759635ms
            out_bf16x2f32: -1828.62500000 , time:0.05926609ms
           out_bf16x2bf16: -1821.26562500 , time:0.06394410ms
        out_bf16x8packf32: -1812.37145996 , time:0.04711747ms
       out_bf16x8packbf16: -1809.75000000 , time:0.04567599ms
          out_bf16bf16_th: -1824.00000000 , time:0.06634998ms
--------------------------------------------------------------------------------
            out_f8e4m3f16: -1760.09960938 , time:0.18968844ms
     out_f8e4m3x16packf16: -1759.36328125 , time:0.04217148ms
         out_f8e4m3f16_th: -1759.00000000 , time:0.07843924ms
--------------------------------------------------------------------------------
            out_f8e5m2f16: -1654.13085938 , time:0.16458154ms
     out_f8e5m2x16packf16: -1655.91015625 , time:0.02646923ms
         out_f8e5m2f16_th: -1655.00000000 , time:0.04918027ms
--------------------------------------------------------------------------------
                out_i8i32: -1740          , time:0.16149735ms
         out_i8x16packi32: -1740          , time:0.02719522ms
             out_i8i32_th: -1740          , time:0.36653495ms
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
                                        S=4096, K=1024
               out_f32f32: 539.47326660   , time:0.08422852ms
             out_f32x4f32: 539.47131348   , time:0.04583454ms
            out_f32f32_th: 539.47326660   , time:0.05531430ms
--------------------------------------------------------------------------------
               out_f16f16: 538.31677246   , time:0.08287168ms
               out_f16f32: 539.25268555   , time:0.08176708ms
             out_f16x2f32: 539.04821777   , time:0.03241825ms
             out_f16x2f16: 540.05859375   , time:0.03441882ms
         out_f16x8packf16: 541.00927734   , time:0.02908969ms
         out_f16x8packf32: 539.25354004   , time:0.04165292ms
            out_f16f16_th: 539.50000000   , time:0.04000640ms
--------------------------------------------------------------------------------
             out_bf16bf16: 548.67187500   , time:0.08616281ms
              out_bf16f32: 541.57470703   , time:0.08303046ms
            out_bf16x2f32: 542.34729004   , time:0.03319907ms
           out_bf16x2bf16: 538.10156250   , time:0.05163050ms
        out_bf16x8packf32: 546.54504395   , time:0.04867697ms
       out_bf16x8packbf16: 561.89062500   , time:0.04262376ms
          out_bf16bf16_th: 540.00000000   , time:0.03297901ms
--------------------------------------------------------------------------------
            out_f8e4m3f16: 425.61718750   , time:0.08309484ms
     out_f8e4m3x16packf16: 430.60351562   , time:0.02459788ms
         out_f8e4m3f16_th: 427.75000000   , time:0.02917218ms
--------------------------------------------------------------------------------
            out_f8e5m2f16: 502.55664062   , time:0.07583904ms
     out_f8e5m2x16packf16: 500.55273438   , time:0.01922584ms
         out_f8e5m2f16_th: 501.25000000   , time:0.02832794ms
--------------------------------------------------------------------------------
                out_i8i32: 783            , time:0.06880260ms
         out_i8x16packi32: 783            , time:0.03624558ms
             out_i8i32_th: 783            , time:0.18682122ms
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
                                        S=4096, K=2048
               out_f32f32: 2584.00097656  , time:0.15605998ms
             out_f32x4f32: 2584.00683594  , time:0.08461046ms
            out_f32f32_th: 2584.00585938  , time:0.08694196ms
--------------------------------------------------------------------------------
               out_f16f16: 2584.09790039  , time:0.15599012ms
               out_f16f32: 2584.01586914  , time:0.15545368ms
             out_f16x2f32: 2584.31860352  , time:0.08359194ms
             out_f16x2f16: 2583.67675781  , time:0.08289003ms
         out_f16x8packf16: 2583.80224609  , time:0.04493332ms
         out_f16x8packf32: 2584.01074219  , time:0.04578376ms
            out_f16f16_th: 2584.00000000  , time:0.04857492ms
--------------------------------------------------------------------------------
             out_bf16bf16: 2580.04687500  , time:0.16197824ms
              out_bf16f32: 2590.28735352  , time:0.15596652ms
            out_bf16x2f32: 2585.70166016  , time:0.08244228ms
           out_bf16x2bf16: 2567.32812500  , time:0.08601213ms
        out_bf16x8packf32: 2581.78540039  , time:0.04585719ms
       out_bf16x8packbf16: 2596.56250000  , time:0.04510450ms
          out_bf16bf16_th: 2592.00000000  , time:0.04896641ms
--------------------------------------------------------------------------------
            out_f8e4m3f16: 2628.59375000  , time:0.18758702ms
     out_f8e4m3x16packf16: 2626.84570312  , time:0.04120755ms
         out_f8e4m3f16_th: 2628.00000000  , time:0.04840589ms
--------------------------------------------------------------------------------
            out_f8e5m2f16: 2735.96875000  , time:0.16217518ms
     out_f8e5m2x16packf16: 2735.94140625  , time:0.07037091ms
         out_f8e5m2f16_th: 2738.00000000  , time:0.04730439ms
--------------------------------------------------------------------------------
                out_i8i32: 1589           , time:0.16064048ms
         out_i8x16packi32: 1589           , time:0.02776194ms
             out_i8i32_th: 1589           , time:0.35617042ms
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
                                        S=4096, K=4096
               out_f32f32: 3947.60766602  , time:0.30719018ms
             out_f32x4f32: 3947.59448242  , time:0.16208410ms
            out_f32f32_th: 3947.59350586  , time:0.16445303ms
--------------------------------------------------------------------------------
               out_f16f16: 3947.00610352  , time:0.30440331ms
               out_f16f32: 3948.21264648  , time:0.30352330ms
             out_f16x2f32: 3947.51318359  , time:0.11666965ms
             out_f16x2f16: 3945.69433594  , time:0.11910439ms
         out_f16x8packf16: 3947.47070312  , time:0.08507514ms
         out_f16x8packf32: 3948.22460938  , time:0.08437824ms
            out_f16f16_th: 3948.00000000  , time:0.09051609ms
--------------------------------------------------------------------------------
             out_bf16bf16: 3923.82812500  , time:0.31600809ms
              out_bf16f32: 3946.21655273  , time:0.30327702ms
            out_bf16x2f32: 3950.64941406  , time:0.11408114ms
           out_bf16x2bf16: 3984.87500000  , time:0.12254214ms
        out_bf16x8packf32: 3962.01513672  , time:0.08430576ms
       out_bf16x8packbf16: 3985.98437500  , time:0.08453608ms
          out_bf16bf16_th: 3952.00000000  , time:0.08731151ms
--------------------------------------------------------------------------------
            out_f8e4m3f16: 3995.20507812  , time:0.36618781ms
     out_f8e4m3x16packf16: 3996.55273438  , time:0.07873940ms
         out_f8e4m3f16_th: 3998.00000000  , time:0.08972001ms
--------------------------------------------------------------------------------
            out_f8e5m2f16: 3868.67578125  , time:0.31633973ms
     out_f8e5m2x16packf16: 3875.77929688  , time:0.04530287ms
         out_f8e5m2f16_th: 3872.00000000  , time:0.08772039ms
--------------------------------------------------------------------------------
                out_i8i32: 5515           , time:0.31193781ms
         out_i8x16packi32: 5515           , time:0.04495645ms
             out_i8i32_th: 5515           , time:0.69676852ms
--------------------------------------------------------------------------------
```
