# HGEMM 

## 0x00 说明

包含以下内容：

- [X] hgemm_sliced_k_f16_kernel 
- [X] hgemm_t_8x8_sliced_k_f16x4_kernel(unpack)
- [X] hgemm_t_8x8_sliced_k_f16x4_pack_kernel(pack 16x4)
- [X] hgemm_t_8x8_sliced_k_f16x4_bcf_kernel([ongoing], bank conflicts free)
- [X] hgemm_t_8x8_sliced_k_f16x4_pack_bcf_kernel([ongoing], bank conflicts free, pack)
- [X] PyTorch bindings

## 测试

```bash
# 只测试Ada架构 不指定默认编译所有架构 耗时较长: Volta, Ampere, Ada, Hopper, ...
export TORCH_CUDA_ARCH_LIST=Ada 
python3 hgemm.py
```

输出:

```bash
------------------------------------------------------------------------------------------
                                   M=2048, N=2048, K=1024
               out_f16: ['-1.22949219 ', '-34.09375   ', '26.71875    '], time:2.383578ms
           out_f16(sk): ['-1.22949219 ', '-34.09375   ', '26.71875    '], time:1.774100ms
     out_f16x4(t8x8sk): ['-1.22949219 ', '-34.09375   ', '26.71875    '], time:0.232159ms
    out_f16x4(t8x8bcf): ['-1.22949219 ', '-34.09375   ', '26.71875    '], time:0.219339ms
 out_f16x4pack(t8x8sk): ['-1.22949219 ', '-34.09375   ', '26.71875    '], time:0.216471ms
    out_f16x4pack(bcf): ['-1.22949219 ', '-34.09375   ', '26.71875    '], time:0.202703ms
            out_f16_th: ['-1.08984375 ', '-34.125     ', '26.796875   '], time:0.084666ms
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
                                   M=2048, N=2048, K=2048
               out_f16: ['-2.1171875  ', '-99.625     ', '-47.5625    '], time:4.751714ms
           out_f16(sk): ['-2.1171875  ', '-99.625     ', '-47.5625    '], time:3.531904ms
     out_f16x4(t8x8sk): ['-2.1171875  ', '-99.625     ', '-47.5625    '], time:0.454522ms
    out_f16x4(t8x8bcf): ['-2.1171875  ', '-99.625     ', '-47.5625    '], time:0.437381ms
 out_f16x4pack(t8x8sk): ['-2.1171875  ', '-99.625     ', '-47.5625    '], time:0.429300ms
    out_f16x4pack(bcf): ['-2.1171875  ', '-99.625     ', '-47.5625    '], time:0.402763ms
            out_f16_th: ['-2.10351562 ', '-99.6875    ', '-47.5625    '], time:0.163152ms
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
                                   M=2048, N=4096, K=1024
               out_f16: ['-28.28125   ', '13.2734375  ', '16.71875    '], time:4.742397ms
           out_f16(sk): ['-28.28125   ', '13.2734375  ', '16.71875    '], time:3.524252ms
     out_f16x4(t8x8sk): ['-28.28125   ', '13.2734375  ', '16.71875    '], time:0.443467ms
    out_f16x4(t8x8bcf): ['-28.28125   ', '13.2734375  ', '16.71875    '], time:0.419147ms
 out_f16x4pack(t8x8sk): ['-28.28125   ', '13.2734375  ', '16.71875    '], time:0.408547ms
    out_f16x4pack(bcf): ['-28.28125   ', '13.2734375  ', '16.71875    '], time:0.385830ms
            out_f16_th: ['-28.296875  ', '13.15625    ', '16.734375   '], time:0.168549ms
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
                                   M=2048, N=4096, K=2048
               out_f16: ['-7.36328125 ', '26.171875   ', '75.3125     '], time:9.454781ms
           out_f16(sk): ['-7.36328125 ', '26.171875   ', '75.3125     '], time:7.027287ms
     out_f16x4(t8x8sk): ['-7.36328125 ', '26.171875   ', '75.3125     '], time:0.870588ms
    out_f16x4(t8x8bcf): ['-7.36328125 ', '26.171875   ', '75.3125     '], time:0.832881ms
 out_f16x4pack(t8x8sk): ['-7.36328125 ', '26.171875   ', '75.3125     '], time:0.807931ms
    out_f16x4pack(bcf): ['-7.36328125 ', '26.171875   ', '75.3125     '], time:0.766319ms
            out_f16_th: ['-7.49609375 ', '25.9375     ', '75.5625     '], time:0.324421ms
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
                                   M=4096, N=2048, K=1024
               out_f16: ['-71.375     ', '21.4375     ', '8.265625    '], time:4.741104ms
           out_f16(sk): ['-71.375     ', '21.4375     ', '8.265625    '], time:3.528599ms
     out_f16x4(t8x8sk): ['-71.375     ', '21.4375     ', '8.265625    '], time:0.447476ms
    out_f16x4(t8x8bcf): ['-71.375     ', '21.4375     ', '8.265625    '], time:0.419341ms
 out_f16x4pack(t8x8sk): ['-71.375     ', '21.4375     ', '8.265625    '], time:0.409360ms
    out_f16x4pack(bcf): ['-71.375     ', '21.4375     ', '8.265625    '], time:0.384452ms
            out_f16_th: ['-71.5625    ', '21.4375     ', '8.109375    '], time:0.168383ms
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
                                   M=4096, N=2048, K=2048
               out_f16: ['16.25       ', '114.875     ', '16.46875    '], time:9.453067ms
           out_f16(sk): ['16.25       ', '114.875     ', '16.46875    '], time:7.030333ms
     out_f16x4(t8x8sk): ['16.25       ', '114.875     ', '16.46875    '], time:0.872086ms
    out_f16x4(t8x8bcf): ['16.25       ', '114.875     ', '16.46875    '], time:0.836916ms
 out_f16x4pack(t8x8sk): ['16.25       ', '114.875     ', '16.46875    '], time:0.813516ms
    out_f16x4pack(bcf): ['16.25       ', '114.875     ', '16.46875    '], time:0.771128ms
            out_f16_th: ['16.578125   ', '115.875     ', '16.453125   '], time:0.325354ms
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
                                   M=4096, N=4096, K=1024
               out_f16: ['-3.81445312 ', '28.25       ', '-46.03125   '], time:9.449681ms
           out_f16(sk): ['-3.81445312 ', '28.25       ', '-46.03125   '], time:7.024680ms
     out_f16x4(t8x8sk): ['-3.81445312 ', '28.25       ', '-46.03125   '], time:0.857885ms
    out_f16x4(t8x8bcf): ['-3.81445312 ', '28.25       ', '-46.03125   '], time:0.813354ms
 out_f16x4pack(t8x8sk): ['-3.81445312 ', '28.25       ', '-46.03125   '], time:0.796700ms
    out_f16x4pack(bcf): ['-3.81445312 ', '28.25       ', '-46.03125   '], time:0.753065ms
            out_f16_th: ['-3.83203125 ', '28.0625     ', '-45.78125   '], time:0.333290ms
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
                                   M=4096, N=4096, K=2048
               out_f16: ['50.125      ', '17.125      ', '28.765625   '], time:18.847528ms
           out_f16(sk): ['50.125      ', '17.125      ', '28.765625   '], time:14.016824ms
     out_f16x4(t8x8sk): ['50.125      ', '17.125      ', '28.765625   '], time:1.693937ms
    out_f16x4(t8x8bcf): ['50.125      ', '17.125      ', '28.765625   '], time:1.633234ms
 out_f16x4pack(t8x8sk): ['50.125      ', '17.125      ', '28.765625   '], time:1.593070ms
    out_f16x4pack(bcf): ['50.125      ', '17.125      ', '28.765625   '], time:1.512836ms
            out_f16_th: ['50.34375    ', '17.421875   ', '29.265625   '], time:0.647020ms
------------------------------------------------------------------------------------------
```
