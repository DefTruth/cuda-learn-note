# HGEMM 

## 0x00 说明

包含以下内容：

- [X] hgemm_sliced_k_f16_kernel 
- [X] hgemm_t_8x8_sliced_k_f16x4_kernel(unpack)
- [X] hgemm_t_8x8_sliced_k_f16x4_pack_kernel(pack 16x4)
- [X] hgemm_t_8x8_sliced_k_f16x4_bcf_kernel([ongoing], bank conflicts free)
- [X] hgemm_t_8x8_sliced_k_f16x4_pack_bcf_kernel([ongoing], bank conflicts free, pack)
- [X] hgemm_t_4x4_sliced_k_f16x4_pack_bcf_kernel([ongoing], bank conflicts free)
- [X] PyTorch bindings

## 测试

```bash
# 只测试Ada架构 不指定默认编译所有架构 耗时较长: Volta, Ampere, Ada, Hopper, ...
export TORCH_CUDA_ARCH_LIST=Ada 
python3 hgemm.py
```

输出:

```bash
------------------------------------------------------------------------------------------
                                   M=4096, N=1024, K=256
                   out_f16: ['-9.046875   ', '23.765625   ', '-33.59375   '], time:0.606316ms
               out_f16(sk): ['-9.046875   ', '23.765625   ', '-33.59375   '], time:0.455358ms
         out_f16x4(t8x8sk): ['-9.046875   ', '23.765625   ', '-33.59375   '], time:0.065656ms
        out_f16x4(t8x8bcf): ['-9.046875   ', '23.765625   ', '-33.59375   '], time:0.057951ms
     out_f16x4pack(t8x8sk): ['-9.046875   ', '23.765625   ', '-33.59375   '], time:0.058119ms
        out_f16x4pack(bcf): ['-9.046875   ', '23.765625   ', '-33.59375   '], time:0.053847ms
     out_f16x4pack(offset): ['-9.046875   ', '23.765625   ', '-33.59375   '], time:0.053735ms
    out_f16x4pack(t4x4bcf): ['-9.046875   ', '23.765625   ', '-33.59375   '], time:0.070539ms
 out_f16x4pack(t4x4offset): ['-9.046875   ', '23.765625   ', '-33.59375   '], time:0.069182ms
                out_f16_th: ['-9.0546875  ', '23.734375   ', '-33.6875    '], time:0.025289ms
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
                                   M=4096, N=1024, K=512
                   out_f16: ['-20.296875  ', '-20.25      ', '-7.6015625  '], time:1.198586ms
               out_f16(sk): ['-20.296875  ', '-20.25      ', '-7.6015625  '], time:0.895079ms
         out_f16x4(t8x8sk): ['-20.296875  ', '-20.25      ', '-7.6015625  '], time:0.120682ms
        out_f16x4(t8x8bcf): ['-20.296875  ', '-20.25      ', '-7.6015625  '], time:0.111719ms
     out_f16x4pack(t8x8sk): ['-20.296875  ', '-20.25      ', '-7.6015625  '], time:0.110652ms
        out_f16x4pack(bcf): ['-20.296875  ', '-20.25      ', '-7.6015625  '], time:0.103641ms
     out_f16x4pack(offset): ['-20.296875  ', '-20.25      ', '-7.6015625  '], time:0.103345ms
    out_f16x4pack(t4x4bcf): ['-20.296875  ', '-20.25      ', '-7.6015625  '], time:0.139614ms
 out_f16x4pack(t4x4offset): ['-20.296875  ', '-20.25      ', '-7.6015625  '], time:0.137155ms
                out_f16_th: ['-20.34375   ', '-20.234375  ', '-7.640625   '], time:0.044861ms
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
                                   M=4096, N=1024, K=1024
                   out_f16: ['46.9375     ', '57.59375    ', '1.90722656  '], time:2.382910ms
               out_f16(sk): ['46.9375     ', '57.59375    ', '1.90722656  '], time:1.774279ms
         out_f16x4(t8x8sk): ['46.9375     ', '57.59375    ', '1.90722656  '], time:0.230728ms
        out_f16x4(t8x8bcf): ['46.9375     ', '57.59375    ', '1.90722656  '], time:0.219440ms
     out_f16x4pack(t8x8sk): ['46.9375     ', '57.59375    ', '1.90722656  '], time:0.215820ms
        out_f16x4pack(bcf): ['46.9375     ', '57.59375    ', '1.90722656  '], time:0.203209ms
     out_f16x4pack(offset): ['46.9375     ', '57.59375    ', '1.90722656  '], time:0.202646ms
    out_f16x4pack(t4x4bcf): ['46.9375     ', '57.59375    ', '1.90722656  '], time:0.277444ms
 out_f16x4pack(t4x4offset): ['46.9375     ', '57.59375    ', '1.90722656  '], time:0.272521ms
                out_f16_th: ['46.9375     ', '57.71875    ', '1.89453125  '], time:0.084265ms
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
                                   M=4096, N=2048, K=256
                   out_f16: ['-16.5       ', '-16.109375  ', '-23.328125  '], time:1.204573ms
               out_f16(sk): ['-16.5       ', '-16.109375  ', '-23.328125  '], time:0.904208ms
         out_f16x4(t8x8sk): ['-16.5       ', '-16.109375  ', '-23.328125  '], time:0.128340ms
        out_f16x4(t8x8bcf): ['-16.5       ', '-16.109375  ', '-23.328125  '], time:0.108442ms
     out_f16x4pack(t8x8sk): ['-16.5       ', '-16.109375  ', '-23.328125  '], time:0.109812ms
        out_f16x4pack(bcf): ['-16.5       ', '-16.109375  ', '-23.328125  '], time:0.099840ms
     out_f16x4pack(offset): ['-16.5       ', '-16.109375  ', '-23.328125  '], time:0.099599ms
    out_f16x4pack(t4x4bcf): ['-16.5       ', '-16.109375  ', '-23.328125  '], time:0.131118ms
 out_f16x4pack(t4x4offset): ['-16.5       ', '-16.109375  ', '-23.328125  '], time:0.128663ms
                out_f16_th: ['-16.5       ', '-16.109375  ', '-23.375     '], time:0.046718ms
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
                                   M=4096, N=2048, K=512
                   out_f16: ['-7.80859375 ', '-23.40625   ', '11.5703125  '], time:2.383839ms
               out_f16(sk): ['-7.80859375 ', '-23.40625   ', '11.5703125  '], time:1.778926ms
         out_f16x4(t8x8sk): ['-7.80859375 ', '-23.40625   ', '11.5703125  '], time:0.234842ms
        out_f16x4(t8x8bcf): ['-7.80859375 ', '-23.40625   ', '11.5703125  '], time:0.211662ms
     out_f16x4pack(t8x8sk): ['-7.80859375 ', '-23.40625   ', '11.5703125  '], time:0.209591ms
        out_f16x4pack(bcf): ['-7.80859375 ', '-23.40625   ', '11.5703125  '], time:0.194930ms
     out_f16x4pack(offset): ['-7.80859375 ', '-23.40625   ', '11.5703125  '], time:0.194521ms
    out_f16x4pack(t4x4bcf): ['-7.80859375 ', '-23.40625   ', '11.5703125  '], time:0.260530ms
 out_f16x4pack(t4x4offset): ['-7.80859375 ', '-23.40625   ', '11.5703125  '], time:0.256166ms
                out_f16_th: ['-7.81640625 ', '-23.296875  ', '11.359375   '], time:0.086123ms
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
                                   M=4096, N=2048, K=1024
                   out_f16: ['-0.99902344 ', '36.71875    ', '22.6875     '], time:4.740881ms
               out_f16(sk): ['-0.99902344 ', '36.71875    ', '22.6875     '], time:3.528770ms
         out_f16x4(t8x8sk): ['-0.99902344 ', '36.71875    ', '22.6875     '], time:0.446767ms
        out_f16x4(t8x8bcf): ['-0.99902344 ', '36.71875    ', '22.6875     '], time:0.418006ms
     out_f16x4pack(t8x8sk): ['-0.99902344 ', '36.71875    ', '22.6875     '], time:0.409541ms
        out_f16x4pack(bcf): ['-0.99902344 ', '36.71875    ', '22.6875     '], time:0.384440ms
     out_f16x4pack(offset): ['-0.99902344 ', '36.71875    ', '22.6875     '], time:0.383106ms
    out_f16x4pack(t4x4bcf): ['-0.99902344 ', '36.71875    ', '22.6875     '], time:0.526135ms
 out_f16x4pack(t4x4offset): ['-0.99902344 ', '36.71875    ', '22.6875     '], time:0.515252ms
                out_f16_th: ['-1.05761719 ', '36.84375    ', '22.328125   '], time:0.168767ms
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
                                   M=4096, N=4096, K=256
                   out_f16: ['18.65625    ', '-14.0625    ', '-20.421875  '], time:2.400414ms
               out_f16(sk): ['18.65625    ', '-14.0625    ', '-20.421875  '], time:1.799250ms
         out_f16x4(t8x8sk): ['18.65625    ', '-14.0625    ', '-20.421875  '], time:0.230143ms
        out_f16x4(t8x8bcf): ['18.65625    ', '-14.0625    ', '-20.421875  '], time:0.208182ms
     out_f16x4pack(t8x8sk): ['18.65625    ', '-14.0625    ', '-20.421875  '], time:0.206510ms
        out_f16x4pack(bcf): ['18.65625    ', '-14.0625    ', '-20.421875  '], time:0.191575ms
     out_f16x4pack(offset): ['18.65625    ', '-14.0625    ', '-20.421875  '], time:0.190918ms
    out_f16x4pack(t4x4bcf): ['18.65625    ', '-14.0625    ', '-20.421875  '], time:0.253793ms
 out_f16x4pack(t4x4offset): ['18.65625    ', '-14.0625    ', '-20.421875  '], time:0.247440ms
                out_f16_th: ['18.65625    ', '-14.109375  ', '-20.421875  '], time:0.088673ms
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
                                   M=4096, N=4096, K=512
                   out_f16: ['-10.125     ', '56.28125    ', '-27.734375  '], time:4.752918ms
               out_f16(sk): ['-10.125     ', '56.28125    ', '-27.734375  '], time:3.541149ms
         out_f16x4(t8x8sk): ['-10.125     ', '56.28125    ', '-27.734375  '], time:0.441622ms
        out_f16x4(t8x8bcf): ['-10.125     ', '56.28125    ', '-27.734375  '], time:0.410223ms
     out_f16x4pack(t8x8sk): ['-10.125     ', '56.28125    ', '-27.734375  '], time:0.401660ms
        out_f16x4pack(bcf): ['-10.125     ', '56.28125    ', '-27.734375  '], time:0.377460ms
     out_f16x4pack(offset): ['-10.125     ', '56.28125    ', '-27.734375  '], time:0.375066ms
    out_f16x4pack(t4x4bcf): ['-10.125     ', '56.28125    ', '-27.734375  '], time:0.513331ms
 out_f16x4pack(t4x4offset): ['-10.125     ', '56.28125    ', '-27.734375  '], time:0.504302ms
                out_f16_th: ['-10.171875  ', '56.25       ', '-27.84375   '], time:0.168356ms
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
                                   M=4096, N=4096, K=1024
                   out_f16: ['-18.875     ', '-10.953125  ', '30.359375   '], time:9.449307ms
               out_f16(sk): ['-18.875     ', '-10.953125  ', '30.359375   '], time:7.028043ms
         out_f16x4(t8x8sk): ['-18.875     ', '-10.953125  ', '30.359375   '], time:0.857034ms
        out_f16x4(t8x8bcf): ['-18.875     ', '-10.953125  ', '30.359375   '], time:0.815504ms
     out_f16x4pack(t8x8sk): ['-18.875     ', '-10.953125  ', '30.359375   '], time:0.795797ms
        out_f16x4pack(bcf): ['-18.875     ', '-10.953125  ', '30.359375   '], time:0.753334ms
     out_f16x4pack(offset): ['-18.875     ', '-10.953125  ', '30.359375   '], time:0.749285ms
    out_f16x4pack(t4x4bcf): ['-18.875     ', '-10.953125  ', '30.359375   '], time:1.033822ms
 out_f16x4pack(t4x4offset): ['-18.875     ', '-10.953125  ', '30.359375   '], time:1.028370ms
                out_f16_th: ['-19.0       ', '-10.8125    ', '30.40625    '], time:0.333282ms
------------------------------------------------------------------------------------------```
